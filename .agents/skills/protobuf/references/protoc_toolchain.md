# Protoc Toolchain Reference

Reference for the `protoc` compiler and its ecosystem.
**The buf toolchain is recommended over protoc for new projects**—see [buf_toolchain.md](buf_toolchain.md).
Use this reference when working with existing protoc-based projects.

## When to Use Protoc vs Buf

**Use buf when:**
- Starting a new project
- Project already uses buf.yaml
- Need dependency management from BSR
- Need built-in linting and breaking change detection

**Use protoc when:**
- Project has existing Makefile/scripts using protoc
- Using protoc-specific plugins not available for buf
- Organization mandates protoc

**Detection signals for protoc projects:**
- Makefile with `protoc` commands
- No `buf.yaml` present
- `*.pb.go`, `*_pb2.py` files generated by protoc
- Include paths (`-I` flags) in build scripts
- `protoc-gen-*` binaries in project or PATH

## Installation

Download from [github.com/protocolbuffers/protobuf/releases](https://github.com/protocolbuffers/protobuf/releases)

Or via package manager:
- macOS: `brew install protobuf`
- Linux: `apt-get install -y protobuf-compiler`

### Common Plugins

```bash
# Go
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

# Python
pip install grpcio-tools

# TypeScript/JavaScript
npm install -g @bufbuild/protoc-gen-es
```

## Basic Usage

```bash
# Basic compilation
protoc --proto_path=proto --go_out=gen/go proto/acme/user/v1/user.proto

# Multiple outputs
protoc \
  --proto_path=proto \
  --go_out=gen/go \
  --go-grpc_out=gen/go \
  proto/acme/user/v1/*.proto

# With include paths for dependencies
protoc \
  -I proto \
  -I third_party/googleapis \
  --go_out=gen/go \
  proto/acme/user/v1/user.proto
```

### Key Flags

| Flag | Description |
|------|-------------|
| `--proto_path` / `-I` | Include path for imports (can specify multiple) |
| `--<lang>_out` | Output directory for generated code |
| `--<lang>_opt` | Options for the language plugin |
| `--descriptor_set_out` | Output binary descriptor set |

### Plugin Options

```bash
protoc \
  --proto_path=proto \
  --go_out=gen/go \
  --go_opt=paths=source_relative \
  --go-grpc_out=gen/go \
  --go-grpc_opt=paths=source_relative \
  proto/**/*.proto
```

## Include Paths

Protoc resolves imports relative to include paths (`-I` / `--proto_path`).

```bash
protoc \
  -I proto \                          # Your protos
  -I third_party \                    # Vendored dependencies
  -I /usr/local/include \             # System-installed WKTs
  --go_out=gen/go \
  proto/acme/user/v1/user.proto
```

### Well-Known Types

Google's well-known types (`google/protobuf/*.proto`) are typically installed with protoc.
If not found, check `/usr/local/include` or vendor them.

## Makefile Integration

```makefile
PROTO_DIR := proto
GEN_DIR := gen
PROTOC := protoc

PROTO_FILES := $(shell find $(PROTO_DIR) -name '*.proto')
INCLUDES := -I $(PROTO_DIR) -I third_party/googleapis -I third_party/protobuf/src

.PHONY: generate
generate: $(PROTO_FILES)
	$(PROTOC) $(INCLUDES) \
		--go_out=$(GEN_DIR)/go \
		--go_opt=paths=source_relative \
		--go-grpc_out=$(GEN_DIR)/go \
		--go-grpc_opt=paths=source_relative \
		$(PROTO_FILES)

.PHONY: clean
clean:
	rm -rf $(GEN_DIR)
```

## go_package Requirements

Protoc requires `go_package` option in `.proto` files for Go code generation:

```protobuf
syntax = "proto3";

package acme.user.v1;

option go_package = "github.com/acme/api/gen/go/acme/user/v1;userv1";
```

The format is `<import_path>;<package_name>` where:
- `import_path`: Full Go import path
- `package_name`: (Optional) Go package name, defaults to last path component

**Note:** Buf's managed mode eliminates this requirement—see [buf_toolchain.md](buf_toolchain.md).

## Language-Specific Outputs

### Go

```bash
protoc \
  --go_out=gen/go \
  --go_opt=paths=source_relative \
  --go-grpc_out=gen/go \
  --go-grpc_opt=paths=source_relative \
  proto/**/*.proto
```

**Options:**
- `paths=source_relative`: Output relative to proto file location
- `paths=import`: Output based on go_package (default)

### Python

```bash
python -m grpc_tools.protoc \
  -I proto \
  --python_out=gen/python \
  --grpc_python_out=gen/python \
  proto/**/*.proto
```

### TypeScript/JavaScript

```bash
protoc \
  -I proto \
  --es_out=gen/ts \
  --es_opt=target=ts \
  proto/**/*.proto
```

### Java

```bash
protoc \
  -I proto \
  --java_out=gen/java \
  --grpc-java_out=gen/java \
  proto/**/*.proto
```

## Descriptor Sets

Binary descriptor sets capture compiled proto schemas:

```bash
protoc \
  -I proto \
  --descriptor_set_out=schema.binpb \
  --include_imports \
  --include_source_info \
  proto/**/*.proto
```

Useful for runtime reflection, schema registries, and server reflection.

## Common Issues

See [troubleshooting.md](troubleshooting.md) for detailed solutions to:
- "Import not found" errors
- "go_package option required"
- Plugin not found
- Inconsistent generated code

---

## Migrating to Buf

For step-by-step migration instructions, see [migration.md](migration.md).
